name: Deploy .NET API to AWS EC2

on:
  push:
    branches:
      - backend   # Tự động chạy khi push code lên branch "backend"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clone toàn bộ source code từ repo
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2️⃣ Cài đặt .NET SDK 8.0
      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3️⃣ Build & Publish Web API ra thư mục "publish"
      - name: Publish .NET Web API
        working-directory: ./Backend/BloodDonationSupport/BloodDonationSupport.WebAPI
        run: dotnet publish -c Release -o ../../publish

      # 4️⃣ Kiểm tra thư mục publish sau khi build
      - name: List publish files
        run: |
          echo "Checking publish directory..."
          PUBLISH_DIR="./Backend/BloodDonationSupport/publish"
          if [ -d "$PUBLISH_DIR" ]; then
            echo "✅ Publish directory exists at: $PUBLISH_DIR"
            echo "Files in publish directory:"
            ls -la "$PUBLISH_DIR"
            echo "---"
            echo "Total files count:"
            find "$PUBLISH_DIR" -type f | wc -l
            echo "First 20 files:"
            find "$PUBLISH_DIR" -type f | head -20
          else
            echo "❌ Publish directory not found at: $PUBLISH_DIR"
            echo "Checking parent directory:"
            ls -la ./Backend/BloodDonationSupport/
            echo "Current working directory:"
            pwd
          fi

      # 5️⃣ Upload thư mục publish lên EC2 qua SSH (dùng scp trực tiếp)
      - name: Setup SSH key
        shell: bash
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -T 30 -H "$EC2_HOST" >> ~/.ssh/known_hosts || true

      - name: Upload published files to EC2
        shell: bash
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          # Tạo thư mục đích trên EC2
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER"@"$EC2_HOST" \
            "sudo mkdir -p /var/www/bloodconnect-api && sudo chown -R $EC2_USER:$EC2_USER /var/www/bloodconnect-api"

          # Upload toàn bộ nội dung của thư mục publish
          cd ./Backend/BloodDonationSupport
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r \
            publish/. \
            "$EC2_USER"@"$EC2_HOST":/var/www/bloodconnect-api/

      # 6️⃣ Restart service trên EC2 sau khi upload xong
      - name: Restart API service on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop bloodconnect.service || true
            sudo systemctl daemon-reload
            sudo systemctl start bloodconnect.service
            echo "✅ API restarted successfully!"
