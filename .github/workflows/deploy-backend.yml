name: Deploy .NET API to AWS EC2

on:
  push:
    branches:
      - backend   # Tự động chạy khi push code lên branch "backend"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clone toàn bộ source code từ repo
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2️⃣ Cài đặt .NET SDK 8.0
      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3️⃣ Build & Publish Web API ra thư mục "publish"
      - name: Publish .NET Web API
        working-directory: ./Backend/BloodDonationSupport/BloodDonationSupport.WebAPI
        run: dotnet publish -c Release -o ../../publish

      # 4️⃣ Kiểm tra thư mục publish sau khi build
      - name: List publish files
        run: |
          echo "Checking publish directory..."
          PUBLISH_DIR="./Backend/BloodDonationSupport/publish"
          if [ -d "$PUBLISH_DIR" ]; then
            echo "✅ Publish directory exists at: $PUBLISH_DIR"
            echo "Files in publish directory:"
            ls -la "$PUBLISH_DIR"
            echo "---"
            echo "Total files count:"
            find "$PUBLISH_DIR" -type f | wc -l
            echo "First 20 files:"
            find "$PUBLISH_DIR" -type f | head -20
          else
            echo "❌ Publish directory not found at: $PUBLISH_DIR"
            echo "Checking parent directory:"
            ls -la ./Backend/BloodDonationSupport/
            echo "Current working directory:"
            pwd
          fi

      # 5️⃣ Upload thư mục publish lên EC2 qua SSH
      - name: Upload published files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "Backend/BloodDonationSupport/publish"
          target: "/var/www/bloodconnect-api"
          rm: true

      # 6️⃣ Restart service trên EC2 sau khi upload xong
      - name: Restart API service on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop bloodconnect.service || true
            sudo systemctl daemon-reload
            sudo systemctl start bloodconnect.service
            echo "✅ API restarted successfully!"
